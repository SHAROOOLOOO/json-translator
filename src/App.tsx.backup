import * as React from 'react'
import { useState, useEffect } from 'react'
import { translateService } from './services/translate'
import JsonEditor from './components/JsonEditor'
import './App.css'

interface JsonField {
  path: string
  value: string
  type: string
}

function App() {
  const [jsonInput, setJsonInput] = useState('')
  const [parsedJson, setParsedJson] = useState<any>(null)
  const [fields, setFields] = useState<JsonField[]>([])
  const [selectedFields, setSelectedFields] = useState<Set<string>>(new Set())
  const [targetLanguage, setTargetLanguage] = useState('en')
  const [translatedJson, setTranslatedJson] = useState<any>(null)
  const [editedTranslatedJson, setEditedTranslatedJson] = useState<string>('')
  const [isTranslating, setIsTranslating] = useState(false)
  const [error, setError] = useState('')
  const [translationProgress, setTranslationProgress] = useState(0)
  const [isServiceAvailable, setIsServiceAvailable] = useState<boolean | null>(null)

  const languages = [
    { code: 'en', name: '英语' },
    { code: 'zh', name: '中文' },
    { code: 'ja', name: '日语' },
    { code: 'ko', name: '韩语' },
    { code: 'fr', name: '法语' },
    { code: 'de', name: '德语' },
    { code: 'es', name: '西班牙语' },
    { code: 'ru', name: '俄语' },
  ]

  // Check translation service availability on component mount
  useEffect(() => {
    // Check translation service availability on component mount
    const checkService = async () => {
      try {
        const available = await translateService.checkServiceAvailability()
        setIsServiceAvailable(available)
        if (!available) {
          setError('翻译服务暂时不可用，将使用模拟翻译')
        }
      } catch (error) {
        setIsServiceAvailable(false)
        console.warn('Translation service check failed:', error)
      }
    }

    checkService()
  }, [])

  const parseJson = () => {
    try {
      const parsed = JSON.parse(jsonInput)
      setParsedJson(parsed)
      setError('')
      extractFields(parsed)
    } catch (err) {
      setError('JSON格式错误，请检查输入')
      setParsedJson(null)
      setFields([])
      setSelectedFields(new Set())
    }
  }

  const extractFields = (obj: any, basePath: string = '') => {
    const extractedFields: JsonField[] = []

    const traverse = (current: any, path: string) => {
      if (typeof current === 'string' && current.trim()) {
        extractedFields.push({
          path: path || 'root',
          value: current,
          type: 'string'
        })
      } else if (typeof current === 'object' && current !== null) {
        if (Array.isArray(current)) {
          current.forEach((item, index) => {
            traverse(item, `${path}[${index}]`)
          })
        } else {
          Object.entries(current).forEach(([key, value]) => {
            traverse(value, path ? `${path}.${key}` : key)
          })
        }
      }
    }

    traverse(obj, basePath)
    setFields(extractedFields)
  }

  const toggleField = (path: string) => {
    const newSelected = new Set(selectedFields)
    if (newSelected.has(path)) {
      newSelected.delete(path)
    } else {
      newSelected.add(path)
    }
    setSelectedFields(newSelected)
  }

  const translate = async () => {
    if (selectedFields.size === 0) {
      setError('请选择要翻译的字段')
      return
    }

    setIsTranslating(true)
    setError('')
    setTranslationProgress(0)

    try {
      const result = { ...parsedJson }
      const selectedFieldsArray = Array.from(selectedFields)
      const textsToTranslate: string[] = []

      // Collect all texts to translate
      for (const fieldPath of selectedFieldsArray) {
        const field = fields.find(f => f.path === fieldPath)
        if (field) {
          textsToTranslate.push(field.value)
        }
      }

      // Translate all texts in batch
      setTranslationProgress(25)
      const translatedTexts = await translateService.translateBatch(textsToTranslate, targetLanguage)

      setTranslationProgress(75)

      // Update result with translated texts
      selectedFieldsArray.forEach((fieldPath, index) => {
        if (translatedTexts[index]) {
          setNestedValue(result, fieldPath, translatedTexts[index])
        }
      })

      setTranslationProgress(100)
      setTranslatedJson(result)
      setEditedTranslatedJson(JSON.stringify(result, null, 2))

      // Clear progress after a short delay
      setTimeout(() => setTranslationProgress(0), 1000)

    } catch (err) {
      setError('翻译失败，请重试')
      console.error('Translation error:', err)
    } finally {
      setIsTranslating(false)
    }
  }

  const setNestedValue = (obj: any, path: string, value: any) => {
    const keys = path.split('.')
    const lastKey = keys.pop()!
    let current = obj

    for (const key of keys) {
      if (key.includes('[') && key.includes(']')) {
        const arrayKey = key.split('[')[0]
        const index = parseInt(key.split('[')[1].split(']')[0])
        current = current[arrayKey][index]
      } else {
        current = current[key]
      }
    }

    if (lastKey.includes('[') && lastKey.includes(']')) {
      const arrayKey = lastKey.split('[')[0]
      const index = parseInt(lastKey.split('[')[1].split(']')[0])
      current[arrayKey][index] = value
    } else {
      current[lastKey] = value
    }
  }

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text).then(() => {
      // 可以添加成功提示
    }).catch(err => {
      console.error('复制失败:', err)
    })
  }

  const formatJson = (jsonString: string, minify: boolean = false) => {
    try {
      const parsed = JSON.parse(jsonString)
      return JSON.stringify(parsed, null, minify ? 0 : 2)
    } catch (err) {
      return jsonString
    }
  }

  const selectAllFields = () => {
    const allPaths = new Set(fields.map(f => f.path))
    setSelectedFields(allPaths)
  }

  const clearAllFields = () => {
    setSelectedFields(new Set())
  }

  const resetAll = () => {
    setJsonInput('')
    setParsedJson(null)
    setFields([])
    setSelectedFields(new Set())
    setTranslatedJson(null)
    setEditedTranslatedJson('')
    setError('')
    setTranslationProgress(0)
  }

  const loadExampleJson = () => {
    const exampleJson = {
      "user": {
        "name": "张三",
        "email": "zhangsan@example.com",
        "bio": "这是一位软件工程师的简介，他喜欢编程和技术。",
        "address": {
          "country": "中国",
          "city": "北京",
          "street": "中关村大街1号"
        }
      },
      "products": [
        {
          "id": 1,
          "title": "智能手表",
          "description": "这款智能手表具有心率监测和GPS功能。",
          "price": "¥999"
        },
        {
          "id": 2,
          "title": "无线耳机",
          "description": "高品质音频体验，支持降噪功能。",
          "price": "¥599"
        }
      ],
      "message": "欢迎访问我们的在线商店！"
    }

    setJsonInput(JSON.stringify(exampleJson, null, 2))
    setParsedJson(exampleJson)
    setError('')
    extractFields(exampleJson)
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-gray-50 to-slate-100">
      <div className="max-w-screen-2xl mx-auto">
        {/* 顶部标题栏 */}
        <header className="bg-white shadow-sm border-b border-gray-100">
          <div className="px-8 py-6">
            <div className="flex items-center space-x-4">
              <div className="flex items-center space-x-3">
                <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                  </svg>
                </div>
                <h1 className="text-5xl font-black text-gray-800">
                  JSON 翻译工具
                </h1>
              </div>
            </div>
          </div>
        </header>

        {/* 主要内容区域 */}
        <main className="px-8 py-8">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8" style={{ gridTemplateColumns: '1fr 1fr' }}>
            {/* 左栏：输入相关功能 */}
            <div className="space-y-6">
              {/* JSON输入区域 */}
              <div className="bg-white rounded-2xl shadow-xl border border-blue-200 overflow-hidden hover:shadow-2xl transition-shadow duration-300">
                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-blue-200">
                  <div className="flex justify-between items-center">
                    <div className="flex items-center space-x-4">
                      <div className="w-8 h-8 bg-blue-500 rounded-xl flex items-center justify-center shadow-sm">
                        <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                      </div>
                      <h2 className="text-2xl font-bold text-gray-800">原始 JSON 输入</h2>
                      <button
                        onClick={loadExampleJson}
                        className="px-5 py-2.5 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-sm font-medium rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
                      >
                        加载示例
                      </button>
                    </div>
                    <div className="flex space-x-2">
                      <button
                        onClick={resetAll}
                        className="px-5 py-2.5 bg-gradient-to-r from-red-500 to-red-600 text-white text-sm font-medium rounded-xl hover:from-red-600 hover:to-red-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
                      >
                        重置
                      </button>
                    </div>
                  </div>
                </div>

                {!parsedJson ? (
                  <div className="p-6">
                    <textarea
                      className="w-full h-96 p-4 border-2 border-gray-200 rounded-xl font-mono text-sm focus:ring-4 focus:ring-blue-200 focus:border-blue-400 bg-gray-50 hover:bg-white transition-colors duration-200"
                      placeholder="请输入JSON数据..."
                      value={jsonInput}
                      onChange={(e) => setJsonInput(e.target.value)}
                    />
                    {error && (
                      <div className="mt-4 p-4 bg-red-50 border-2 border-red-200 text-red-700 rounded-xl flex items-center space-x-2">
                        <svg className="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span className="font-medium">{error}</span>
                      </div>
                    )}
                    <button
                      onClick={parseJson}
                      className="mt-6 w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 transform hover:scale-[1.02] shadow-lg hover:shadow-xl font-bold text-lg"
                    >
                      解析 JSON
                    </button>
                  </div>
                ) : (
                  <div className="h-[650px] p-5">
                    <JsonEditor
                      value={parsedJson}
                      readonly={false}
                      height="600px"
                      title=""
                    />
                  </div>
                )}
              </div>

              {/* 字段选择和翻译设置的左右布局 */}
              <div className="grid grid-cols-2 gap-4" style={{ gridTemplateColumns: '1fr 1fr' }}>
                  {/* 字段选择区域 */}
                  <div className="bg-white rounded-2xl shadow-xl border border-green-200 overflow-hidden hover:shadow-2xl transition-shadow duration-300">
                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 px-5 py-4 border-b border-green-200">
                      <div className="flex justify-between items-center">
                        <div className="flex items-center space-x-3">
                          <div className="w-6 h-6 bg-green-500 rounded-lg flex items-center justify-center shadow-sm">
                            <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                          </div>
                          <h3 className="text-lg font-bold text-gray-800">
                            选择翻译字段 ({selectedFields.size}/{fields.length})
                          </h3>
                        </div>
                        <div className="flex space-x-2">
                          <button
                            onClick={selectAllFields}
                            className="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-sm font-medium rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
                          >
                            全选
                          </button>
                          <button
                            onClick={clearAllFields}
                            className="px-4 py-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white text-sm font-medium rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
                          >
                            清除
                          </button>
                        </div>
                      </div>
                    </div>
                    <div className="p-5" style={{ minHeight: '293px' }}>
                      {fields.length > 0 ? (
                        <div className="grid grid-cols-1 gap-3 max-h-80 overflow-y-auto">
                          {fields.map((field) => (
                            <label key={field.path} className="flex items-center p-4 border border-gray-200 rounded-xl hover:bg-green-50 hover:border-green-300 transition-all duration-200 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={selectedFields.has(field.path)}
                                onChange={() => toggleField(field.path)}
                                className="mr-4 h-5 w-5 text-green-600 focus:ring-2 focus:ring-green-200 border-gray-300 rounded-lg"
                              />
                              <div className="flex-1 min-w-0">
                                <div className="font-mono text-sm text-gray-800 font-medium truncate">{field.path}</div>
                              </div>
                            </label>
                          ))}
                        </div>
                      ) : (
                        <div className="h-full flex items-center justify-center">
                          <div className="text-center">
                            <div className="w-16 h-16 bg-gradient-to-r from-gray-100 to-gray-200 rounded-xl flex items-center justify-center mx-auto mb-4">
                              <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                            </div>
                            <p className="text-gray-500 font-medium">请先输入JSON数据</p>
                            <p className="text-gray-400 text-sm mt-1">解析后将显示可翻译字段</p>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* 翻译设置区域 */}
                  <div className="bg-white rounded-2xl shadow-xl border border-purple-200 overflow-hidden hover:shadow-2xl transition-shadow duration-300">
                    <div className="bg-gradient-to-r from-purple-50 to-pink-50 px-5 py-4 border-b border-purple-200">
                      <div className="flex items-center space-x-3">
                        <div className="w-6 h-6 bg-purple-500 rounded-lg flex items-center justify-center shadow-sm">
                          <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                          </svg>
                        </div>
                        <h3 className="text-lg font-bold text-gray-800">翻译设置</h3>
                      </div>
                    </div>
                    <div className="p-5" style={{ minHeight: '293px' }}>
                      <div className="mb-6">
                        <label className="block text-base font-semibold text-gray-700 mb-3">
                          目标语言
                        </label>
                        <select
                          value={targetLanguage}
                          onChange={(e) => setTargetLanguage(e.target.value)}
                          className="w-full p-4 text-base border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-200 focus:border-purple-400 bg-white hover:bg-gray-50 transition-colors duration-200 shadow-sm hover:shadow-md"
                        >
                          {languages.map((lang) => (
                            <option key={lang.code} value={lang.code}>
                              {lang.name}
                            </option>
                          ))}
                        </select>
                      </div>

                      {/* Service availability indicator */}
                      {isServiceAvailable !== null && (
                        <div className="mb-6 flex items-center p-3 bg-green-50 border border-green-200 rounded-xl">
                          <div className="w-3 h-3 rounded-full mr-3 bg-green-500 animate-pulse"></div>
                          <span className="text-sm font-medium text-green-700">
                            翻译服务就绪
                          </span>
                        </div>
                      )}

                      <button
                        onClick={translate}
                        disabled={isTranslating || selectedFields.size === 0}
                        className="w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-[1.02] shadow-lg hover:shadow-xl font-bold text-lg"
                      >
                        {isTranslating ? '翻译中...' : '开始翻译'}
                      </button>
                    </div>
                  </div>
                </div>
            </div>

            {/* 右栏：输出相关功能 */}
            <div className="space-y-6">
              {/* Always show translation results structure */}
                <div className="bg-white rounded-2xl shadow-xl border border-orange-200 overflow-hidden hover:shadow-2xl transition-shadow duration-300">
                  <div className="bg-gradient-to-r from-orange-50 to-yellow-50 px-6 py-4 border-b border-orange-200">
                    <div className="flex justify-between items-center">
                      <div className="flex items-center space-x-3">
                        <div className="w-6 h-6 bg-orange-500 rounded-lg flex items-center justify-center">
                          <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                          </svg>
                        </div>
                        <h2 className="text-2xl font-bold text-gray-800">翻译结果 (可编辑)</h2>
                      </div>
                      <div className="flex space-x-2">
                        <button
                          onClick={() => copyToClipboard(editedTranslatedJson)}
                          className="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm font-medium rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
                        >
                          复制
                        </button>
                        <button
                          onClick={() => setEditedTranslatedJson(formatJson(editedTranslatedJson, false))}
                          className="px-5 py-2.5 bg-gradient-to-r from-green-500 to-green-600 text-white text-sm font-medium rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
                        >
                          格式化
                        </button>
                        <button
                          onClick={() => setEditedTranslatedJson(formatJson(editedTranslatedJson, true))}
                          className="px-5 py-2.5 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white text-sm font-medium rounded-xl hover:from-yellow-600 hover:to-yellow-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
                        >
                          压缩
                        </button>
                      </div>
                    </div>
                  </div>
                  <div className="p-6">
                    {isTranslating ? (
                      <div className="flex items-center justify-center h-[650px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                        <div className="text-center">
                          <svg className="w-12 h-12 animate-spin text-blue-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                          </svg>
                          <p className="text-lg font-medium text-gray-700 mb-2">正在翻译中...</p>
                          {translationProgress > 0 && (
                            <div className="mt-4 w-64">
                              <div className="flex justify-between text-sm text-gray-600 mb-2">
                                <span>进度</span>
                                <span className="font-medium text-blue-600">{translationProgress}%</span>
                              </div>
                              <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                <div
                                  className="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                                  style={{ width: `${translationProgress}%` }}
                                ></div>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    ) : translatedJson ? (
                    <JsonEditor
                      value={editedTranslatedJson}
                      onChange={setEditedTranslatedJson}
                      readonly={false}
                      height="650px"
                      title=""
                    />
                  ) : (
                    <div className="h-[650px] bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center">
                      <div className="text-center">
                        <div className="w-24 h-24 bg-gradient-to-r from-blue-100 to-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                          <svg className="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                        </div>
                        <p className="text-xl font-semibold text-gray-700 mb-2">
                          {parsedJson ? "选择字段并点击'开始翻译'" : "加载JSON并选择字段"}
                        </p>
                        <p className="text-base text-gray-500">翻译结果将在这里显示</p>
                      </div>
                    </div>
                  )}
                  </div>
                </div>
              </div>
          </div>
        </main>
      </div>
    </div>
  )
}

export default App